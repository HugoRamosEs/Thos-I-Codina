<?php

/**
 * Neteja un string, reemplaçant espais en blanc i alguns altres caracters per guions.
 *
 * Limita la sortida a caràcters alfanumérics, underscore (_) i guions (-).
 * Els espais en blanc es converteixen en guions.
 *
 * @param string $string L'String que es vol netejar
 * @return string L'String netejat.
 */
function sanitize ($stringANetejar, $convertirAlowercase){
    if (empty($stringANetejar)) {
        $stringANetejar = "";
    } else {
        $stringANetejar = htmlspecialchars(stripslashes(trim($stringANetejar, '-')));
        $stringANetejar = strip_tags($stringANetejar);
        // Preserve escaped octets.
        $stringANetejar = preg_replace('|%([a-fA-F0-9][a-fA-F0-9])|', '---$1---', $stringANetejar);
        // Remove percent signs that are not part of an octet.
        $stringANetejar = str_replace('%', '', $stringANetejar);
        // Restore octets.
        $stringANetejar = preg_replace('|---([a-fA-F0-9][a-fA-F0-9])---|', '%$1', $stringANetejar);

        switch ($convertirAlowercase) {
            
            case 1:
                if (function_exists('mb_strtolower')) {
                    $stringANetejar = mb_strtolower($stringANetejar, 'UTF-8');
                } else {
                    $stringANetejar = strtolower($stringANetejar);
                }
                break;
            case 2:
                if (function_exists('mb_strtoupper')) {
                    $stringANetejar = mb_strtoupper($stringANetejar, 'UTF-8');
                } else {
                    $stringANetejar = strtoupper($stringANetejar);
                }
                break;                
        }
        
       // $stringANetejar = preg_replace('/[^%a-z0-9 _-]/', '', $stringANetejar);
       // $stringANetejar = preg_replace('/\s+/', '-', $stringANetejar);
       // $stringANetejar = preg_replace('|-+|', '-', $stringANetejar);
    }
    return $stringANetejar;
} 

function crearContrasenya() {
    define("LONG", 12);
    
    $validos = "abcdefghijklmnopqrstuvwxyz0123456789-_#$%&@";
    $totalValidos = strlen($validos)-1;
    
    $strPassword = "";
    for ($i=0; $i < LONG ; $i++) {
        $valorAleatorio = rand(0,$totalValidos);
        $strPassword .= $validos[$valorAleatorio];
    }
    return $strPassword;
}

function generarPassword($nivellDeSeguretat) {
    $passwordGenerat = "";
    $caractersValidos = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVXYZ0123456789-_#$%&@";
    $caractersExpecials = array("-","_","#","$","%","&","@");
    $passwordCompleixRestriccions = false;
    $conteMajuscules = false;
    $conteMinuscules = false;
    $conteNumeros = false;
    $conteCaractesEspecials = false;
    
    
    //Calculem la longitut del password segons les estriccions imposades.
    switch ($nivellDeSeguretat) {
        case 0:
            $longitutDelPassword = mt_rand(4,10);
            break;
        case 1:
        case 2:
            $longitutDelPassword = mt_rand(8,20);
            break;
    }
    
    while ((!$passwordCompleixRestriccions)) {
        //Escullo una letra aleatroriament
        $lletraEscollidaAleatoriament = $caractersValidos[mt_rand(0,strlen($caractersValidos)-1)];
        
        $passwordGenerat .= $lletraEscollidaAleatoriament;
        
        if (preg_match("/[A-Z]/", $lletraEscollidaAleatoriament) === 1) {
            $conteMajuscules = true;
        } elseif (preg_match("/[a-z]/", $lletraEscollidaAleatoriament) === 1) {
            $conteMinuscules = true;
        } elseif (preg_match("/[0-9]/", $lletraEscollidaAleatoriament) === 1) {
            $conteNumeros = true;
        } elseif (in_array($lletraEscollidaAleatoriament, $caractersExpecials)) {
            $conteCaractesEspecials = true;
        }
        
        if (strlen($passwordGenerat) >= $longitutDelPassword) {
            // Ja hem generat el password de la longitut que volimem.
            // Verifiquem les seves característiques
            switch ($nivellDeSeguretat) {
                case 0:
                    // tindrà la longitut dessitjada, per tant ja puc acabar
                    $passwordCompleixRestriccions = true;
                    break;
                case 1:
                    // Si te majúscula, minúscula i número, ja puc acabar. En cas contrari torno a començar.
                    if ($conteMajuscules && $conteMinuscules && $conteNumeros) {
                        $passwordCompleixRestriccions = true;
                    } else {
                        $passwordGenerat = "";
                    }
                    break;
                case 2:
                    // Si te majúscula, minúscula, número i caràcter escecial, ja puc acabar. En cas contrari torno a començar.
                    if ($conteMajuscules && $conteMinuscules && $conteNumeros && $conteCaractesEspecials) {
                        $passwordCompleixRestriccions = true;
                    } else {
                        $passwordGenerat = "";
                    }
                    break;
            }
            
        }
        
    }
    
    return $passwordGenerat;
}

function esTipus($dadaAVerificar) {
    $tipusValids = array ("NIF", "NIE", "PAS");
    if (in_array($dadaAVerificar, $tipusValids) ) {
        $esCorrecte = true;
    } else {
        $esCorrecte = false;
    }
    return $esCorrecte;
}
function esSexe($dadaAVerificar) {
    $tipusValids = array ("H", "D");
    if (in_array($dadaAVerificar, $tipusValids) ) {
        $esCorrecte = true;
    } else {
        $esCorrecte = false;
    }
    return $esCorrecte;
}

function validarNif ($nif) {
    $nif = strtoupper($nif);
    $lletresValides = "TRWAGMYFPDXBNJZSQVHLCKE";
    $nifCorrecte = FALSE;
    
    if ((strlen($nif)== 9) && (strpos("XYZ0123456789",$nif[0])!==false)) {
        $numero = substr($nif, 0, 8);
        $numero = str_replace(array('X', 'Y', 'Z'), array(0, 1, 2), $numero);
        
        if(substr($nif, -1, 1) == substr($lletresValides, $numero % 23, 1)) {
            $nifCorrecte = TRUE;
        }
    }
    return $nifCorrecte;
}

function esEmail($emailAVerificar) {
    if (filter_var($emailAVerificar,FILTER_VALIDATE_EMAIL)) {
        $esEmail = true;
    } else {
        $esEmail = false;
    }
    return $esEmail;
}

function esNom($nomAValidar) {
    if (preg_match("/^[a-z ']*$/",$nomAValidar)) {
        $esNom = true;
    } else {
        $esNom = false;
    }
    return $esNom;
}

function esCodiPostal($codiPostalAVerificar) {
    if ((strlen($codiPostalAVerificar) == 5) && (is_numeric($codiPostalAVerificar))) {
        $esCP = true;
    } else {
        $esCP = false;
    }
    return $esCP;
}

function esProvincia($provinciaAVerificar) {
    $provincias = array('alava', 'arava','albacete','alacant','alicante','almería','asturias','avila','badajoz','barcelona','burgos','cáceres',
        'cádiz','cantabria','castelló','castellón','ciudad real','córdoba','la coruña','cuenca','girona','gerona','granada','guadalajara',
        'guipuzkoa','guipúzcoa','huelva','huesca','illes balears','islas baleares','jaén','león','lleida','lérida','lugo','madrid','málaga','murcia','navarra',
        'orense','palencia','las palmas','pontevedra','la rioja','salamanca','segovia','sevilla','soria','tarragona',
        'santa cruz de tenerife','teruel','toledo','valència','valencia','valladolid','bizkaia','vizcaya','zamora','zaragoza');
    if (in_array($provinciaAVerificar,$provincias)) {
        $esUnProvincia = true;
    } else {
        $esUnProvincia = false;
    }
    return $esUnProvincia;
}

function esTelefon($telefonAVerificar) {
    if ((strlen($telefonAVerificar)== 9) && (is_numeric($telefonAVerificar)) ) {
        $esTelefon = true;
    } else {
        $esTelefon = false;
    }
    return $esTelefon;
}

function esExperiencia($experienciaAVerificar) {
    $experiencies = array('D', 'R','B','MB');
    if (in_array($experienciaAVerificar, $experiencies)) {
        $esUnaExperiencia = true;
    } else {
        $esUnaExperiencia = false;
    }
    return $esUnaExperiencia;
}

function esPais($paisAVerificar) {
    $paises=array("Afganistán", "Akrotiri", "Albania", "Alemania", "Andorra", "Angola", "Anguila", "Antártida", "Antigua y Barbuda", "Antillas Neerlandesas", "Arabia Saudí", "Arctic Ocean", "Argelia", "Argentina", "Armenia", "Aruba", "Ashmore andCartier Islands", "Atlantic Ocean", "Australia", "Austria", "Azerbaiyán", "Bahamas", "Bahráin", "Bangladesh", "Barbados", "Bélgica", "Belice", "Benín", "Bermudas", "Bielorrusia", "Birmania Myanmar", "Bolivia", "Bosnia y Hercegovina", "Botsuana", "Brasil", "Brunéi", "Bulgaria", "Burkina Faso", "Burundi", "Bután", "Cabo Verde", "Camboya", "Camerún", "Canadá", "Chad", "Chile", "China", "Chipre", "Clipperton Island", "Colombia", "Comoras", "Congo", "Coral Sea Islands", "Corea del Norte", "Corea del Sur", "Costa de Marfil", "Costa Rica", "Croacia", "Cuba", "Dhekelia", "Dinamarca", "Dominica", "Ecuador", "Egipto", "El Salvador", "El Vaticano", "Emiratos Árabes Unidos", "Eritrea", "Eslovaquia", "Eslovenia", "España", "Estados Unidos", "Estonia", "Etiopía", "Filipinas", "Finlandia", "Fiyi", "Francia", "Gabón", "Gambia", "Gaza Strip", "Georgia", "Ghana", "Gibraltar", "Granada", "Grecia", "Groenlandia", "Guam", "Guatemala", "Guernsey", "Guinea", "Guinea Ecuatorial", "Guinea-Bissau", "Guyana", "Haití", "Honduras", "Hong Kong", "Hungría", "India", "Indian Ocean", "Indonesia", "Irán", "Iraq", "Irlanda", "Isla Bouvet", "Isla Christmas", "Isla Norfolk", "Islandia", "Islas Caimán", "Islas Cocos", "Islas Cook", "Islas Feroe", "Islas Georgia del Sur y Sandwich del Sur", "Islas Heard y McDonald", "Islas Malvinas", "Islas Marianas del Norte", "IslasMarshall", "Islas Pitcairn", "Islas Salomón", "Islas Turcas y Caicos", "Islas Vírgenes Americanas", "Islas Vírgenes Británicas", "Israel", "Italia", "Jamaica", "Jan Mayen", "Japón", "Jersey", "Jordania", "Kazajistán", "Kenia", "Kirguizistán", "Kiribati", "Kuwait", "Laos", "Lesoto", "Letonia", "Líbano", "Liberia", "Libia", "Liechtenstein", "Lituania", "Luxemburgo", "Macao", "Macedonia", "Madagascar", "Malasia", "Malaui", "Maldivas", "Malí", "Malta", "Man, Isle of", "Marruecos", "Mauricio", "Mauritania", "Mayotte", "México", "Micronesia", "Moldavia", "Mónaco", "Mongolia", "Montserrat", "Mozambique", "Namibia", "Nauru", "Navassa Island", "Nepal", "Nicaragua", "Níger", "Nigeria", "Niue", "Noruega", "Nueva Caledonia", "Nueva Zelanda", "Omán", "Pacific Ocean", "Países Bajos", "Pakistán", "Palaos", "Panamá", "Papúa-Nueva Guinea", "Paracel Islands", "Paraguay", "Perú", "Polinesia Francesa", "Polonia", "Portugal", "Puerto Rico", "Qatar", "Reino Unido", "República Centroafricana", "República Checa", "República Democrática del Congo", "República Dominicana", "Ruanda", "Rumania", "Rusia", "Sáhara Occidental", "Samoa", "Samoa Americana", "San Cristóbal y Nieves", "San Marino", "San Pedro y Miquelón", "San Vicente y las Granadinas", "Santa Helena", "Santa Lucía", "Santo Tomé y Príncipe", "Senegal", "Seychelles", "Sierra Leona", "Singapur", "Siria", "Somalia", "Southern Ocean", "Spratly Islands", "Sri Lanka", "Suazilandia", "Sudáfrica", "Sudán", "Suecia", "Suiza", "Surinam", "Svalbard y Jan Mayen", "Tailandia", "Taiwán", "Tanzania", "Tayikistán", "TerritorioBritánicodel Océano Indico", "Territorios Australes Franceses", "Timor Oriental", "Togo", "Tokelau", "Tonga", "Trinidad y Tobago", "Túnez", "Turkmenistán", "Turquía", "Tuvalu", "Ucrania", "Uganda", "Unión Europea", "Uruguay", "Uzbekistán", "Vanuatu", "Venezuela", "Vietnam", "Wake Island", "Wallis y Futuna", "West Bank", "World", "Yemen", "Yibuti", "Zambia", "Zimbabue");
    if (in_array($paisAVerificar,$paises)) {
        $esUnPais = true;
    } else {
        $esUnPais = false;
    }
    return $esUnPais;
}

function esComentari($comentariAVerificar) {
    $esUnComentari = true;
    
    return $esUnComentari;
}

function enviaMail($frm_nom, $frm_email, $cod) {
    // procés 'enviament del e-meil de confirmació.
    $hdr="MIME-Version: 1.0\n";
    $hdr.="Content-type: text/html; charset=iso-8859-1\n";
    $hdr.="Content-Transfer-Encoding: 8bit\n";
    $hdr.="X-Priority: 1\n";
    $hdr.="X-MSMail-Priority: High\n";
    $hdr.="From: \"My Web\" <theverybest@myweb.cat>\n";
    
    $bod.="<body style='margin:0px;'>\n<center>\n<table cellpadding='0' cellspacing='0' width='1024'>\n<tr>\n<td>\n<table cellpadding='0' cellspacing='0' width='685' height='144'>\n<tr>\n<td width='685' background='http://localhost/img/tituloemail.jpg'>\n</td>\n\n\n</tr>\n</table>\n</td>\n</tr>\n<tr>\n<td bgcolor='#FFFFFF' width='1024'>\n";
    
    $bod.="<table cellpadding='10' cellspacing='0'><tr><td><font size='3'>Bienvingut/da ".$frm_nom.",\n<p>\nEt donem la benvinguda de nou i volem agrair-te la confiança que has dipositat en nosaltres.\n<p>\nA continuaci&#243; pulsa aquest enllaç per poder completar el teu registre i activar el teu compte:\n<p>\n<a href='http://localhost/php/confirmacio.php?tipo=conf&cod=".$cod."'>http://localhost/confirmacio/index.php?tipo=conf&cod=".$cod."</a>\n<p>\n";
    
    $bod.="Gracies per tot i per qualsevol dubte et pots dirigir a info@myweb.cat\n<p>\n<p>\nAtentament,\n<p>\nEquip de MyWeb\n";
    $bod.="</td>\n</tr>\n</table>\n</td>\n</tr>\n</table>\n</center>\n";
    $bod.="</body>\n</html>\n";
    
    // @mail($frm_email,"Alta en MyWeb",$bod,$hdr);
}
