<?php
//error_reporting(E_ALL);
//ini_set("display_errors", 1);
include_once 'functions.php';

spl_autoload_register(function ($clase) {
    include 'classes/' . strtolower($clase) . '.class.php';
});
    

$opcionsExperiencia = [
    "MB" => "Molt bona",
    "B" => "Bona",
    "R" => "Regular",
    "D" => "Dolenta",
    "MD" => "Molt dolenta"
];

if ($_SERVER["REQUEST_METHOD"]=="GET" && isset($_GET["lang"])) {
    $lang = $_GET["lang"];
    setcookie("lang",$lang,time()+3600);
} else {
    if (isset($_COOKIE["lang"])) {
        $lang = $_COOKIE["lang"];
    } else {
        $lang = "ca";
    }
}

$fitxerDeTraduccions = "languages/".$lang."_traduccio.php";
require_once $fitxerDeTraduccions;

$html_opacityLang[$lang]="style=\"opacity:1;\"";

if ($_SERVER["REQUEST_METHOD"]=="POST" && (isset($_POST["boto"]))) {
    $frmNom = sanitize($_POST["nom"],4);
    $frmMail = sanitize($_POST["email"],1);
    $frmExperiencia = sanitize($_POST["experiencia"],0);
    $frmMsg = sanitize($_POST["missatge"],3);
    
    if (strlen($frmNom)==0) {
        $errors["nom"] = "Has d'informar un nom";
    }
    if (!filter_var($frmMail, FILTER_VALIDATE_EMAIL)) {
        $errors["mail"] = "L'adreça de correu no és vàlida";
    }
    if (!in_array($frmExperiencia, array_keys($opcionsExperiencia))) {
        $errors["missatge"] = "Error en selecció experiencia";
    }
    if (strlen($frmMsg)==0) {
        $errors["missatge"] = "Has d'escriure el comentari que vols enviar";
    }

    if (!isset($errors)) {
        ComentariModel::create(new Comentari($frmNom, $frmEmail, $frmExperiencia, $frmMsg));
        unset($frmNom, $frmEmail, $frmExperiencia, $frmMsg);
        $missatgeOK="El comentari s'ha enviat correctament";
    }
}


/*
 * 
 * <input type="text" name="nom" placeholder="<?php echo $contacteNom;?>" value="<?php echo $frmNom; ?>">
 * <span class="error"><?php echo $errors["nom"];?></span>
 */

$options = [
    "type" => "text",
    "name" => "nom",
    "placeholder" => "Digue'ns el teu nom",
    "value" => $frmNom,
    "span" => $errorsDetectats["nom"]
];
$input_nom = html_generaInput($options);

/*
 * <input type="text" name="email" placeholder="<?php echo $contacteMail;?>" value="<?php echo $frmMail; ?>">
 * <span class="error"><?php echo $errors["mail"];?></span>
 */
$options = [
    "type" => "text",
    "name" => "email",
    "placeholder" => "Digue'ns el teu mail per pasar-nos en contacte",
    "value" => $frmMail,
    "span" => $errorsDetectats["mail"]
];
$input_mail = html_generaInput($options);

$atributs = [
    "name" => "experiencia",
    "span" => $errorsDetectats["experiencia"]
];
$seleccionat = (isset($frmExperiencia)) ? $frmExperiencia : "MB";
$select_Experiencia = html_generateSelect($opcionsExperiencia, $seleccionat, $atributs);

$options = [
    "type" => "textarea",
    "rows" => "4",
    "name" => "missatge",
    "placeholder" => "Què ens vols dir?",
    "value" => $frmMissatge,
    "span" => $errorsDetectats["missatge"]
];
$input_missatge = html_generaInput($options);


?>


<!DOCTYPE html>
<html lang="en">
<?php include "templates/head.tpl.php";?>
<body>
	<?php include "templates/header.tpl.php";?>
	<?php include "templates/info_guestbookform.tpl.php";?>
	<?php include "templates/footer.tpl.php";?>
</body>
</html>


