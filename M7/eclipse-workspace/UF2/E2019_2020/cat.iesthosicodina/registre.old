<?php


require_once 'php/generalFunctions.php';
require_once 'php/variablesDeconfiguracio.php';

require_once 'php/idioma.php';

if (($_SERVER["REQUEST_METHOD"] == "POST") && ($_POST["submit"]=="Envia")) {
    $paginaActual = 98;
    // Hem arribar per un post
    // Verifiquem les dades que han arribat.
    
    $sEmail = sanitize($_POST["email"],1);
    $sPassword = sanitize($_POST["pass"],0);
    $cPassword = sanitize($_POST["cpass"],0);
    
    $sTipus = sanitize($_POST["tipus"],2);
    $sDni = sanitize($_POST["dni"],2);
    $sNom =  sanitize($_POST["nom"],1);
    $sCognoms = sanitize($_POST["cognoms"],1);
    $sSexe = sanitize($_POST["sexe"],2);
    $dNaixement = sanitize($_POST["naixement"],0);
    
    $sAdreca = sanitize($_POST["adreca"],1);
    $sCP = sanitize($_POST["cp"],0);
    $sPoblacio= sanitize($_POST["poblacio"],1);
    $sProvincia = sanitize($_POST["provincia"],1);
    $sTelefon = sanitize($_POST["telefon"],0);
    
    if ($sEmail == "") {
        $errorsDetectats["email"] = "l'email és una dada obligatòria, si us plau indica-la.";
    } else {
        if (!esEmail($sEmail)) {
            $errorsDetectats["email"] = "l'email no té un format adient.";
            unset($sEmail);
        }
    }
    
    if (($sPassword == "") || ($cPassword == "")) {
        $errorsDetectats["pass"] = "El password és una dada obligatòria, si us plau indica-la.";
    } else {
        if ($sPassword != $cPassword) {
            $errorsDetectats["cpass"] = "La repetició del password no correspon amb el password entrat.";
        }
    }
    
    if (!esTipus($sTipus)) {
        $errorsDetectats["tipus"] = "Hi ha algun error amb el tipus";
        unset($sTipus);
    }
    
    if ($sDni == "") {
        $errorsDetectats["dni"] = "El dni és una dada obligatòria, si us plau indica-la.";
    } else {
        if (($sTipus!="pas") && (!validarNif($sDni))) {
            $errorsDetectats["dni"] = "El dni no té un format correcte.";
            unset($sDni);
        }
    }
    
    if ($sNom == "") {
        $errorsDetectats["nom"] = "El nom és una dada obligatòria, si us plau indica-la.";
    } else {
        if (!esNom($sNom)) {
            $errorsDetectats["nom"] = "El nom no té un format correcte.";
            unset($sNom);
        }
    }
    
    if ($sCognoms == "") {
        $errorsDetectats["cognoms"] = "El nom és una dada obligatòria, si us plau indica-la.";
    } else {
        if (!esNom($sCognoms)) {
            $errorsDetectats["cognoms"] = "Els cognoms no tenen un format correcte.";
            unset($sCognoms);
        }
    }
    
    if (!esSexe($sSexe)) {
        $errorsDetectats["sexe"] = "Hi ha hagut algun problema amb la seleccio de sexe.";
        unset($sSexe);
    }
    
    if (($sCP != "") && (!esCodiPostal($sCP))) {
        $errorsDetectats["cp"] = "Els codi postal no correspon a cap població.";
        unset($esCodiPostal);
    }
    
    if (($sProvincia != "") && (!esProvincia($sProvincia))) {
        $errorsDetectats["provincia"] = "La provincia no és una de les espanyoles.";
        unset($sProvincia);
    }
    
    if (($sTelefon != "") && (!esTelefon($sTelefon))) {
        $errorsDetectats["telefon"] = "El format del telèfon no és correcte.";
        unset($sTelefon);
    }

    //Hi ha algun tipus d'error en el formulari d'entrada de dades.
    //No segueixo fetificant.
    if (isset($errorsDetectats)) {
        $errorsDetectats["error"] = "S'ha detectat algun tipus d'error. Revisa les dades introduides.";
    } else {
        //No hi ha errors de formulari..... 
        //Verifico la pujada de la foto.

        if ($_FILES['imatge']['error'] == 0) {                              //Si hi ha foto ....
            $imatge = 		$_FILES['imatge']['tmp_name'];				  	//carreguem el nom temporal del fitxer
            $nomOriginal = 	$_FILES['imatge']['name'];						//carreguem el nom original
            $sImatge = $nomOriginal;
            $tamany= 		$_FILES['imatge']['size']; 						//carreguem el tamany del fitxer en bytes
            $error= 		$_FILES['imatge']['error']; 					//carreguem el tamany del fitxer en bytes
            $tipus= 		$_FILES['imatge']['type']; 						//carreguem el tipus mime del fitxer en bytes
            
            if ($error ===0) {
                $aNom = explode('.',$nomOriginal);								// Busquem l'extensió del fitxer
                $aNomLong = count($aNom);										// ens diu quants elements té l'array
                $sExtensio = strtolower($aNom[--$aNomLong]);
                    
                // Verifiquem si hi ha errors en la pujada del fitxer:
                if( in_array($sExtensio, $formatsImatgesPermesos) ){							// format incorrecte per extensió
                    if ( in_array ($tipus, $mimesImatgesPermesos) ) {	                			// format incorrecte per mime
                        if ($tamany > 2097152) {												// tamany massa gran
                            $errorsDetectats["imatge"] = "Error2013 - Tamany excessiu del fitxer";
                        } else {
                            $nomNou = microtime(true).'_'.$nomOriginal;				// Afegim l'hora per fer un fitxer únic
                            $rutaNova = $directoriDePujades.$nomNou;				// Afegim el path al nom del fitxer
                            $result = move_uploaded_file($imatge , $rutaNova);		// Movem el fitxer a la carpeta
                             
                            if (!$result){
                                $errorsDetectats["imatge"] = "Error2014 - Problemes al moure el fitxer definitiu";
                            }
                        }
                    } else {
                        $errorsDetectats["imatege"] = "Error2012 - El format intern del fitxer no està permés";
                    }
                } else {
                    $errorsDetectats["imatge"] = "Error2011 - Tipus de fitxer amb extensió no permesa";
                }
            } else { 
                // Si s'ha intentat pujar un fitxer però ha donat error.
                // Si no s'ha pujat.... tot ok
                if ($_FILES['imatge']['error'] != 4) {                      
                    $errorsDetectats["imatge"] = "Error2010 - Mo ha pujat el fitxer. Error: " . $error;
                }
            }
        }
        
        if (!isset($errorsDetectats)) {                     // No hi han errors, puc grabar les dades a la BBDD
            $this->user = new User();
            $this->user->setEmail($sEmail);
            $this->user->setPassword($sPassword);
            $this->user->setTipusIdent($sTipus);
            $this->user->setNumeroIdent($sDni);
            $this->user->setNom($sNom);
            $this->user->setCognoms($sCognoms);
            $this->user->setSexe($sSexe);
            $this->user->setDatanaixement($dNaixement);
            $this->user->setAdreca($sAdreca);
            $this->user->setCodiPostal($sCP);
            $this->user->setPoblacio($sPoblacio);
            $this->user->setProvincia($sProvincia);
            $this->user->setTelefon($sTelefon);
            $this->user->setImatge($rutaNova);
            $this->user->setStatus(0);
            
            $sNavegador = substr($_SERVER["HTTP_USER_AGENT"], 0, strpos($_SERVER["HTTP_USER_AGENT"], "("));
            $iniciCadena = strpos($_SERVER["HTTP_USER_AGENT"], "(") + 1;
            $finalCadena = strpos($_SERVER["HTTP_USER_AGENT"], ")") - 1;
            $sPlataforma = substr($_SERVER["HTTP_USER_AGENT"], $iniciCadena, $finalCadena - $iniciCadena);
            
            $this->user->setNavegador($sNavegador);
            $this->user->setPlataforma($sPlataforma);
            
            $mUsuari = new UserModel();
            if ($mUsuari->esEmailUnic($sEmail)) {
                if (!is_null($mUsuari->saveUser($usuari))) {
                    enviaMail($sEmail, $sNom, $idDelRegistreInsertat);
                    header("Location: index.php?pg=100&reg=$idDelRegistreInsertat");
                } else {
                    $errorsDetectats = $mUsuari->getErrors();
                }
            }
        }
    }
    if (isset($errorsDetectats)) {
        $errorsDetectats["error"] = "S'ha detectat algun tipus d'error. Revisa les dades introduides.";
    }
} else {
    $sEmail = "";
    $sPassword = "";
    $cPassword = "";
    $sDni = "";
    $sNom = "";
    $sCognoms = "";
    $sAdreca = "";
    $sCP = "";
    $sPoblacio= "";
    $sProvincia = "";
    $sTelefon = "";
}



include "plantilles/header.php";
include "plantilles/navigationIdiomes.php";
include "plantilles/navigation.php";
include "plantilles/register.php";
include "plantilles/footer.php";